/*
 * fis
 * http://fis.baidu.com/
 */

'use strict';

exports.name = 'release'; //模块名称
exports.desc = 'build and deploy your project'; //模块描述
exports.register = function(commander){
    
    function watch(opt){
        var root = fis.project.getProjectPath(); // 获取项目根目录
        var timer = -1;
        var safePathReg = /[\\\/][_\-.\s\w]+$/i;
        var ignoredReg = /[\/\\](?:output\b[^\/\\]*([\/\\]|$)|\.|fis-conf\.js$)/i;
        opt.srcCache = fis.project.getSource();
        function listener(type){
            return function (path) {
                if(safePathReg.test(path)){
                    var file = fis.file.wrap(path);
                    if (type == 'add' || type == 'change') {
                        if (!opt.srcCache[file.subpath]) {
                            var file = fis.file(path);
                            opt.srcCache[file.subpath] = file;
                        }
                    } else if (type == 'unlink') {
                        if (opt.srcCache[file.subpath]) {
                            delete opt.srcCache[file.subpath];
                        }
                    } else if (type == 'unlinkDir') {
                         fis.util.map(opt.srcCache, function (subpath, file) {
                            if (file.realpath.indexOf(path) !== -1) {
                                delete opt.srcCache[subpath];
                            }
                        });                       
                    }
                    clearTimeout(timer);
                    timer = setTimeout(function(){
                        release(opt);
                    }, 500);
                }
            };
        }

        //添加usePolling配置
        var usePolling = null;

        if (typeof fis.config.get('project.watch.usePolling') !== 'undefined'){
            usePolling = fis.config.get('project.watch.usePolling');
        }

        // 加载模块 https://www.npmjs.com/package/chokidar
        // 实现对项目目录内文件等变化实时监听
        require('chokidar')
            .watch(root, {
                // 需要忽略监听的文件
                ignored : function(path){
                    var ignored = ignoredReg.test(path);
                    if (fis.config.get('project.exclude')){
                        ignored = ignored ||
                            fis.util.filter(path, fis.config.get('project.exclude'));
                    }
                    if (fis.config.get('project.watch.exclude')){
                        ignored = ignored ||
                            fis.util.filter(path, fis.config.get('project.watch.exclude'));
                    }
                    return ignored;
                },
                usePolling: usePolling, // 是否使用轮训，默认false
                persistent: true // 持续性，默认true
            })
            .on('add', listener('add'))
            .on('change', listener('change'))
            .on('unlink', listener('unlink'))
            .on('unlinkDir', listener('unlinkDir'))
            .on('error', function(err){
                //fis.log.error(err);
            });
    }
    
    //函数回调执行用时计数
    function time(fn){
        process.stdout.write('\n δ '.bold.yellow);
        var now = Date.now();
        fn();
        process.stdout.write((Date.now() - now + 'ms').green.bold);
        process.stdout.write('\n');
    }
    
    var LRServer, LRTimer;
    function reload(){
        if(LRServer && LRServer.connections) {
            fis.util.map(LRServer.connections, function(id, connection){
                try {
                    connection.send({
                        command: 'reload',
                        path: '*',
                        liveCSS: true
                    });
                } catch (e) {
                    try {
                        connection.close();
                    } catch (e) {}
                    delete LRServer.connections[id];
                }
            });
        }
    }
    
    var lastModified = {};
    var collection = {};
    var total = {};
    var deploy = require('./lib/deploy.js'); //加载部署模块
    
    //定时执行reload
    deploy.done = function(){
        clearTimeout(LRTimer);
        LRTimer = setTimeout(reload, 200);
    };
    
    //发布项目
    function release(opt){
        var flag, cost, start = Date.now();
        process.stdout.write('\n Ω '.green.bold); //发布开始
        opt.beforeEach = function(file){
            flag = opt.verbose ? '' : '.';
            cost = (new Date).getTime();
            total[file.subpath] = file;
        };
        opt.afterEach = function(file){
            //cal compile time
            cost = (new Date).getTime() - cost;
            if(cost > 200){
                flag = flag.bold.yellow;
                fis.log.debug(file.realpath);
            } else if(cost < 100){
                flag = flag.grey;
            }
            var mtime = file.getMtime().getTime();
            //collect file to deploy
            if(file.release && lastModified[file.subpath] !== mtime){
                if(!collection[file.subpath]){
                    process.stdout.write(flag);
                }
                lastModified[file.subpath] = mtime;
                collection[file.subpath] = file;
            }
        };
        
        opt.beforeCompile = function(file){
            collection[file.subpath] = file;
            process.stdout.write(flag);
        };
        
        try {
            //release
            fis.release(opt, function(ret){
                process.stdout.write(
                    (opt.verbose ? '' : ' ') +
                    (Date.now() - start + 'ms').bold.green + '\n'
                );
                var changed = false;
                fis.util.map(collection, function(key, file){
                    //get newest file from src
                    collection[key] = ret.src[key] || file;
                    changed = true;
                });
                if (changed){
                    if(opt.unique){
                        time(fis.compile.clean);
                    }
                    fis.util.map(ret.pkg, function(subpath, file){
                        collection[subpath] = file;
                        total[subpath] = file;
                    });
                    deploy(opt, collection, total);
                    collection = {};
                    total = {};
                    return;
                }
            });
        } catch(e) {
            process.stdout.write('\n [ERROR] ' + (e.message || e) + '\n');
            if(opt.watch){
                //参考 https://msdn.microsoft.com/zh-cn/library/az24scfc.aspx
                //'\u0007' 为报警 (bell) 符。
                process.stdout.write('\u0007');
            } else if(opt.verbose) {
                throw e;
            } else {
                process.exit(1);
            }
        }
    }
    
    //通过commander注册参数选项
    //参考 https://github.com/tj/commander.js/blob/master/examples
    commander
        //-d 参数短命令，--dest 长命令，需要参数值<names>，短描，参数值类型，参数默认值
        .option('-d, --dest <names>', 'release output destination', String, 'preview')
        .option('-m, --md5 [level]', 'md5 release option', Number)
        .option('-D, --domains', 'add domain name', Boolean, false)
        .option('-l, --lint', 'with lint', Boolean, false)
        .option('-t, --test', 'with unit testing', Boolean, false)
        .option('-o, --optimize', 'with optimizing', Boolean, false)
        .option('-p, --pack', 'with package', Boolean, true)
        .option('-w, --watch', 'monitor the changes of project')
        .option('-L, --live', 'automatically reload your browser')
        .option('-c, --clean', 'clean compile cache', Boolean, false)
        .option('-r, --root <path>', 'set project root')
        .option('-f, --file <filename>', 'set fis-conf file')
        .option('-u, --unique', 'use unique compile caching', Boolean, false)
        .option('--verbose', 'enable verbose output', Boolean, false)
        .action(function(){
            //获取参数中的options对象
            var options = arguments[arguments.length - 1];
            
            fis.log.throw = true; //遇到错误信息则抛出错误

            //configure log
            //是否输出详细日志信息，Boolean，默认false。
            //如果命令行有此参数则执行
            if(options.verbose){
                fis.log.level = fis.log.L_ALL;
            }
            var root, conf, filename = 'fis-conf.js';
            //指定fis-conf配置文件，而非默认的'fis-conf.js'文件。
            if(options.file){
                if(fis.util.isFile(options.file)){
                    conf = fis.util.realpath(options.file);
                } else {
                    fis.log.error('invalid fis config file path [' + options.file + ']');
                }
            }
            //指定项目根目录
            if(options.root){
                root = fis.util.realpath(options.root);
                if(fis.util.isDir(root)){
                    //如果木有指定fis-conf文件，则使用默认的'fis-conf.js'文件。
                    if(!conf && fis.util.isFile(root + '/' + filename)){
                        conf = root + '/' + filename;
                    }
                    delete options.root; //删除选项信息，防止选项缓存
                } else {
                    fis.log.error('invalid project root path [' + options.root + ']');
                }
            } else {
                //如果木有指定项目根目录，则指定当前进程所在运行目录为项目根目录。
                root = fis.util.realpath(process.cwd());
                if(!conf){
                    //try to find fis-conf.js
                    var cwd = root, pos = cwd.length;
                    do {
                        cwd  = cwd.substring(0, pos);
                        conf = cwd + '/' + filename;
                        //如果进程所在目录存在fis-conf文件，则此目录为项目根目录。
                        if(fis.util.exists(conf)){
                            root = cwd;
                            break;
                        } else { //否则向上层目录查找fis-conf文件。
                            conf = false;
                            pos = cwd.lastIndexOf('/');
                        }
                    } while(pos > 0);
                }
            }
            
            //init project
            //设置项目根目录
            fis.project.setProjectRoot(root);
            //保存命令行信息及项目根目录信息到process.title。
            process.title = 'fis ' + process.argv.splice(2).join(' ') + ' [ ' + root + ' ]';

            if(conf){
                //缓存conf信息
                //cache为构造器Cache的实例
                var cache = fis.cache(conf, 'conf');
                if(!cache.revert()){
                    options.clean = true; //清理编译后的缓存
                    cache.save();
                }
                require(conf); //加载配置文件fis-conf，设置配置信息。
            } else { //如果木有fis-conf文件则输出警告信息。
                fis.log.warning('missing config file [' + filename + ']');
            }
            
            //是否清理缓存中编译目录缓存
            if(options.clean){
                time(function(){
                    fis.cache.clean('compile'); //清理编译后的缓存
                });
            }
            delete options.clean; //删除选项信息，防止选项缓存
            
            //domain, fuck EventEmitter
            if(options.domains){
                options.domain = true;
                delete options.domains;
            }
            
            //是否实时在线运行项目
            if(options.live){
                var LiveReloadServer = require('livereload-server-spec');
                var port = fis.config.get('livereload.port', 8132); //获取livereload端口信息，如果木有，则使用默认8132。
                LRServer = new LiveReloadServer({
                    id: 'com.baidu.fis',
                    name: 'fis-reload',
                    version : fis.cli.info.version,
                    port : port,
                    protocols: {
                        monitoring: 7
                    }
                });
                LRServer.on('livereload.js', function(req, res) {
                    var script = fis.util.fs.readFileSync(__dirname + '/vendor/livereload.js');
                    res.writeHead(200, {
                        'Content-Length': script.length,
                        'Content-Type': 'text/javascript',
                        'Connection': 'close'
                    });
                    res.end(script);
                });
                LRServer.listen(function(err) {
                    if (err) {
                        err.message = 'LiveReload server Listening failed: ' + err.message;
                        fis.log.error(err);
                    }
                });
                process.stdout.write('\n Ψ '.bold.yellow + port + '\n');
                //fix mac livereload
                process.on('uncaughtException', function (err) {
                    if(err.message !== 'read ECONNRESET') throw  err;
                });
                //delete options.live;
            }
            
            //是否使用md5，及设置加密级别
            switch (typeof options.md5){
                case 'undefined':
                    options.md5 = 0;
                    break;
                case 'boolean':
                    options.md5 = options.md5 ? 1 : 0;
                    break;
                default :
                    options.md5 = isNaN(options.md5) ? 0 : parseInt(options.md5);
            }
            //md5 > 0, force release hash file
            //如果使用md5，则强制使用md5后缀改变文件名称。
            options.hash = options.md5 > 0;
            
            //是否监听文件变化
            if(options.watch){
                watch(options);
            } else {
                release(options); //项目构建
            }
        });
};
