/*
 * fis
 * http://fis.baidu.com/
 */

'use strict';

var last = Date.now(); //记录当前时间戳

//oo
//var a = function(){};
//var b = a.derive();
//b 会继承自 a 的原型属性、constructor 的原型属性、proto对象的属性，并执行 a、constructor函数体。
Function.prototype.derive = function(constructor, proto){
    if(typeof constructor === 'object'){
        proto = constructor;
        constructor = proto.constructor || function(){};
        delete proto.constructor;
    }
    var parent = this; // a
    var fn = function(){
        parent.apply(this, arguments);
        constructor.apply(this, arguments);
    };
    var tmp = function(){};
    tmp.prototype = parent.prototype;
    var fp = new tmp(), // 继承 a 原型属性
        cp = constructor.prototype,
        key;
    for(key in cp){ // copy继承 constructor 原型属性
        if(cp.hasOwnProperty(key)){
            fp[key] = cp[key];
        }
    }
    proto = proto || {};
    for(key in proto){
        if(proto.hasOwnProperty(key)){
            fp[key] = proto[key];
        }
    }
    fp.constructor = constructor.prototype.constructor;
    fn.prototype = fp;
    return fn;
};

//factory 工厂方法
//var a = function(){};
//var b = a.factory();
//var c = b();
//c 会继承自 a 的原型属性，并执行 a 函数体。
Function.prototype.factory = function(){
    var clazz = this;
    function F(args){
        clazz.apply(this, args);
    }
    F.prototype = clazz.prototype; // F 继承 clazz 原型属性
    return function(){
        return new F(arguments);
    };
};

//暴露接口
var fis = module.exports = {};

//register global variable
//将fis命名空间注册到global全局变量，可枚举，不可修改，值为fis接口。
Object.defineProperty(global, 'fis', {
    enumerable : true,
    writable : false,
    value : fis
});

//注册事件触发器
//参考 https://nodejs.org/api/events.html
fis.emitter = new (require('events').EventEmitter);

//time for debug
//debug 调试器
fis.time = function(title){
    console.log(title + ' : ' + (Date.now() - last) + 'ms');
    last = Date.now();
};

//log
fis.log = require('./lib/log.js');

//require
fis.require = function(){
    var path;
    var name = Array.prototype.slice.call(arguments, 0).join('-');
    if(fis.require._cache.hasOwnProperty(name)) return fis.require._cache[name];
    var names = [];
    for(var i = 0, len = fis.require.prefixes.length; i < len; i++){
        try {
            var pluginName = fis.require.prefixes[i] + '-' + name;
            names.push(pluginName);
            path = require.resolve(pluginName);
            try {
                return fis.require._cache[name] = require(pluginName);
            } catch (e){
                fis.log.error('load plugin [' + pluginName + '] error : ' + e.message);
            }
        } catch (e){}
    }
    fis.log.error('unable to load plugin [' + names.join('] or [') + ']');
};

fis.require._cache = {};

fis.require.prefixes = ['fis'];

//system config
fis.config = require('./lib/config.js');

//utils
fis.util = require('./lib/util.js');

//resource location
fis.uri = require('./lib/uri.js');

//project
fis.project = require('./lib/project.js');

//file
fis.file = require('./lib/file.js');

//cache
fis.cache = require('./lib/cache.js');

//compile kernel
fis.compile = require('./lib/compile.js');

//release api
fis.release = require('./lib/release.js');

//package info
fis.info = fis.util.readJSON(__dirname + '/package.json');

//kernel version
fis.version = fis.info.version;