/*
 * fis
 * http://fis.baidu.com/
 */

'use strict';

exports.DEFAULT_REMOTE_REPOS = 'http://fis.baidu.com/repos';

exports.getSource = function(){
    var root = exports.getProjectPath(), //获取项目根目录
        source = {}, //存储所有文件
        project_exclude = /^(\/output\b|\/fis-[^\/]+)$/, //构建时不包含这些文件或目录
        include = fis.config.get('project.include'), // （project配置中）构建时应该包含的文件或目录
        exclude = fis.config.get('project.exclude'); // （project配置中）构建时不应该包含的文件或目录
    if (fis.util.is(exclude, 'Array')){
        project_exclude = [project_exclude].concat(exclude);
    }else if (exclude){
        project_exclude = [project_exclude, exclude];
    }
    fis.util.find(root, include, project_exclude, root).forEach(function(file){
        file = fis.file(file);
        if (file.release) {
            source[file.subpath] = file;
        }
    });
    return source;
};

//paths
var PROJECT_ROOT;
var TEMP_ROOT;

//获取路径
//@args {Array|LikeArray}
function getPath(root, args){
    if(args && args.length > 0){
        args = root + '/' + Array.prototype.join.call(args, '/');
        return fis.util(args);
    } else {
        return fis.util(root);
    }
}

function initDir(path, title){
    if(fis.util.exists(path)){
        if(!fis.util.isDir(path)){
            fis.log.error('unable to set path[' + path + '] as ' + title + ' directory.');
        }
    } else {
        fis.util.mkdir(path);
    }
    path = fis.util.realpath(path);
    if(path){
        return path;
    } else {
        fis.log.error('unable to create dir [' + path + '] for ' + title + ' directory.');
    }
}

//获取项目根目录
exports.getProjectPath = function(){
    if(PROJECT_ROOT){
        //如果有参数（arguments有值），则添加到根目录之后。
        return getPath(PROJECT_ROOT, arguments);
    } else {
        fis.log.error('undefined project root');
    }
};

//设置项目根目录
exports.setProjectRoot = function(path){
    if(fis.util.isDir(path)){
        PROJECT_ROOT = fis.util.realpath(path);
    } else {
        fis.log.error('invalid project root path [' + path + ']');
    }
};

exports.setTempRoot = function(tmp){
    TEMP_ROOT = initDir(tmp);
};

exports.getTempPath = function(){
    if(!TEMP_ROOT){
        var list = ['FIS_TEMP_DIR', 'LOCALAPPDATA', 'APPDATA', 'HOME'];
        var name = fis.cli && fis.cli.name ? fis.cli.name : 'fis';
        var tmp;
        for(var i = 0, len = list.length; i < len; i++){
            if(tmp = process.env[list[i]]){
                break;
            }
        }
        tmp = tmp || __dirname + '/../';
        exports.setTempRoot(tmp + '/.' + name + '-tmp');
    }
    return getPath(TEMP_ROOT, arguments);
};

exports.getCachePath = function(){
    return getPath(exports.getTempPath('cache'), arguments);
};
